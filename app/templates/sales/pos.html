{% extends "base.html" %}
{% block content %}
<div class="container">
    <div class="pos-container">
        
        <div class="pos-cart card">
            <div class="pos-search-box" style="position: relative;">
                <label>üîç Buscar Produto (C√≥digo ou Nome)</label>
                <input type="text" id="product-search" class="form-control" 
                       placeholder="Digite: martelo, 001, etc..." 
                       autocomplete="off"
                       onkeypress="if(event.key === 'Enter') selectFirstResult()">
                
                <div id="search-results" style="position: absolute; width: 100%; background: var(--card-light); 
                     z-index: 1000; border: 1px solid var(--border-light); display: none; 
                     box-shadow: 0 10px 20px rgba(0,0,0,0.2); border-radius: 0 0 10px 10px;">
                </div>
            </div>

            <table class="table table-pos">
                <thead>
                    <tr>
                        <th>C√ìD</th>
                        <th>PRODUTO</th>
                        <th style="width: 80px;">QTD</th>
                        <th>UNIT.</th>
                        <th>SUBTOTAL</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="cart-items"></tbody>
            </table>
        </div>

        <div class="pos-checkout card">
            <div class="total-display">
                <h5>Total da Venda</h5>
                <span class="value" id="final-total">R$ 0,00</span>
            </div>

            <div class="payment-methods">
                <label>Forma de Pagamento</label>
                <select id="payment-method" class="form-control" onchange="updateUI()">
                    <option value="dinheiro">Dinheiro (Esp√©cie)</option>
                    <option value="pix">PIX</option>
                    <option value="debito">Cart√£o D√©bito</option>
                    <option value="credito">Cart√£o Cr√©dito</option>
                </select>

                <div id="credit-options" style="display:none;">
                    <label>Parcelas (+4% por parcela)</label>
                    <input type="number" id="installments" class="form-control" value="1" min="1" onchange="renderCart()">
                </div>

                <div id="cash-options">
                    <label>Valor Pago</label>
                    <input type="number" id="cash-in" class="form-control" placeholder="0,00" oninput="calcChange()">
                    <div class="change-box">
                        <small>Troco:</small>
                        <h3 id="change-display">R$ 0,00</h3>
                    </div>
                </div>
            </div>

            <button class="btn-finalize" onclick="finalizeSale()">
                FINALIZAR VENDA (BAIXAR ESTOQUE)
            </button>
        </div>
    </div>
</div>

<script>
let cart = [];
const searchInput = document.getElementById('product-search');
const resultsDiv = document.getElementById('search-results');

// --- BUSCA DIN√ÇMICA (SUGEST√ïES AO DIGITAR) ---
searchInput.addEventListener('input', function() {
    const query = this.value;
    if (query.length < 2) {
        resultsDiv.style.display = 'none';
        return;
    }

    fetch(`/inventory/api/search?q=${query}`)
        .then(res => res.json())
        .then(data => {
            if (data.length > 0) {
                resultsDiv.innerHTML = '';
                data.forEach(item => {
                    const div = document.createElement('div');
                    div.style.padding = '12px';
                    div.style.cursor = 'pointer';
                    div.style.borderBottom = '1px solid var(--border-light)';
                    div.innerHTML = `
                        <div style="display:flex; justify-content:space-between; color:var(--text-light);">
                            <span><strong>${item.code}</strong> - ${item.name}</span>
                            <span>R$ ${item.price.toFixed(2)}</span>
                        </div>
                    `;
                    div.onclick = () => addToCart(item);
                    resultsDiv.appendChild(div);
                });
                resultsDiv.style.display = 'block';
            } else {
                resultsDiv.style.display = 'none';
            }
        });
});

function addToCart(product) {
    let found = cart.find(i => i.code === product.code);
    if (found) {
        found.qty++;
    } else {
        cart.push({ ...product, qty: 1 });
    }
    renderCart();
    resultsDiv.style.display = 'none';
    searchInput.value = '';
}

function selectFirstResult() {
    const first = resultsDiv.querySelector('div');
    if (first) first.click();
}

function renderCart() {
    let html = '';
    let total = 0;
    cart.forEach((item, idx) => {
        let sub = item.price * item.qty;
        total += sub;
        html += `<tr>
            <td><b>${item.code}</b></td>
            <td>${item.name}</td>
            <td><input type="number" value="${item.qty}" onchange="updateQty(${idx}, this.value)" class="form-control" style="margin:0; padding:5px;"></td>
            <td>R$ ${item.price.toFixed(2)}</td>
            <td>R$ ${sub.toFixed(2)}</td>
            <td><button onclick="remove(${idx})" class="btn-theme" style="background:#ff4d4d">X</button></td>
        </tr>`;
    });
    document.getElementById('cart-items').innerHTML = html;

    let method = document.getElementById('payment-method').value;
    if (method === 'credito') {
        let inst = parseInt(document.getElementById('installments').value) || 1;
        if (inst > 1) total = total * (1 + (0.04 * inst));
    }

    document.getElementById('final-total').innerText = `R$ ${total.toFixed(2)}`;
    calcChange();
}

function updateQty(idx, val) { cart[idx].qty = parseInt(val); renderCart(); }
function remove(idx) { cart.splice(idx, 1); renderCart(); }

function updateUI() {
    let m = document.getElementById('payment-method').value;
    document.getElementById('cash-options').style.display = m === 'dinheiro' ? 'block' : 'none';
    document.getElementById('credit-options').style.display = m === 'credito' ? 'block' : 'none';
    renderCart();
}

function calcChange() {
    let totalText = document.getElementById('final-total').innerText.replace('R$ ', '').replace(',', '.');
    let t = parseFloat(totalText);
    let r = parseFloat(document.getElementById('cash-in').value) || 0;
    let change = r - t;
    document.getElementById('change-display').innerText = `R$ ${change > 0 ? change.toFixed(2) : '0,00'}`;
}

// --- FINALIZAR E BAIXAR ESTOQUE ---
function finalizeSale() {
    if (cart.length === 0) return alert("Adicione produtos primeiro!");

    if (!confirm("Confirmar venda e baixar estoque?")) return;

    fetch('/vendas/finalizar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ cart: cart })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert("‚úÖ Venda realizada! Estoque atualizado.");
            cart = [];
            renderCart();
            document.getElementById('cash-in').value = '';
        } else {
            alert("‚ùå Erro: " + data.error);
        }
    })
    .catch(err => alert("Erro ao conectar com o servidor"));
}

// Fecha sugest√µes ao clicar fora
document.addEventListener('click', (e) => {
    if (e.target !== searchInput) resultsDiv.style.display = 'none';
});
</script>
{% endblock %}